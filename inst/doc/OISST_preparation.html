<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="AJ Smit" />

<meta name="date" content="2018-06-22" />

<title>Retrieval and processing of OISST data</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Retrieval and processing of OISST data</h1>
<h4 class="author"><em>AJ Smit</em></h4>
<h4 class="date"><em>2018-06-22</em></h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>In this vignette we shall look at retrieving and processing the <a href="https://journals.ametsoc.org/doi/full/10.1175/2007JCLI1824.1">Reynolds optimally interpolated sea surface temperature</a> (OISST), which is a global data set of Advanced Very High Resolution Radiometer (AVHRR) derived SSTs at a daily resolution, starting on 1 September 1981. The source of the data is the <a href="https://podaac.jpl.nasa.gov/">Physical Oceanography Distributed Active Archive Centre (PODAAC)</a>.</p>
<!-- ![**Figure 1.** OISST data plotted on a Gnomic Cubic Sphere projection thanks to [Panoply](https://www.giss.nasa.gov/tools/panoply/)---the link to certain religious iconography is purely coincidental. The SST field is filled using the Parula colour scale.](avhrr-only-v2.19810901.png){width=100%} -->
<p>Each global, daily file is around 8.3Mb, so they add up to a large amount of data when a time series of at least 30 years duration is downloaded. A time series of at least 30 years is needed for heatwave detection. Currently I have 13,216 of these global files, and this amounts to ~108Gb of total disk space. Since not everyone will need all of these data, we shall subset the data using a python script prior to downloading them.</p>
</div>
<div id="subsetting-using-a-python-script" class="section level2">
<h2>Subsetting using a python script</h2>
<p>To do the subsetting and bring the data to your local computer/server, you will need access to <strong>python 2.7</strong> with <strong>numpy</strong>. Make sure it is installed on your system and visible on the system PATH.</p>
<p>Create a folder on your server where all the data will be received, below, for example, I use <code>/Users/ajsmit/spatial/test/netCDF</code>.</p>
<p>Into this directory, copy the python script, <code>subset_dataset.py</code> (<a href="https://podaac.jpl.nasa.gov/forum/viewtopic.php?f=5&amp;t=219">link</a>). Remember to make the file executable by running <code>chmod +x subset_dataset.py</code>. I use MacOS X (or linux), so I’m not able to provide instructions if you use Windows. In a terminal, change to the directory that will receive the netCDF files, where the python script now lives. If python is in your system’s path, you should be able to execute the following command on the terminal/command line at the prompt <code>&gt;</code>:</p>
<p><code>&gt; ./subset_dataset.py -s 19810901 -f 20171014 -b 6.25 45 -45 -20 -x AVHRR_OI-NCEI-L4-GLOB-v2.0</code></p>
<p>Encapsulated by the above command are the following parameters:</p>
<ul>
<li>long.min = 6.25</li>
<li>long.max = 45</li>
<li>lat.min = -45</li>
<li>lat.max = -20</li>
<li>start.date = 1981-09-01</li>
<li>end.date = 2017-10-14</li>
<li>short.name = AVHRR_OI-NCEI-L4-GLOB-v2.0</li>
</ul>
<p>The spatial extent is for the Agulhas Current region around South Africa; we select files starting in 1981-09-01 and going up to 2017-10-19. The short name is the name mentioned on the <a href="https://podaac.jpl.nasa.gov/dataset/AVHRR_OI-NCEI-L4-GLOB-v2.0">Reynolds OISST data website</a>—substituting this name for any of the other SST datasets on that website <em>should</em> then permit the retrieval of other data sets (e.g. the <a href="https://podaac.jpl.nasa.gov/dataset/MUR-JPL-L4-GLOB-v4.1">MUR data’s</a> short name is MUR-JPL-L4-GLOB-v4.1).</p>
<p>Adjust any of these parameters to taste in order to define the spatial extent and the time period as required by your study.</p>
<p>If everything works according to plan, a bunch of data will now be downloaded. This might take several hours. There will be one netCDF file for each day of the study period. In later steps in R we shall combine them into one <code>.csv</code> file, and then do some other processing steps on them to extract the heat waves.</p>
</div>
<div id="extracting-the-sst-data" class="section level2">
<h2>Extracting the SST data</h2>
<p>There are many ways to approach this problem, and the one I take here is to produce an intermediate <code>.csv</code> file that has all the data for the region/period of interest—all of it in one file. For the subregion/period defined by the python subsetting function, above, this combined file weighs in at 4.88Gb. This might not be the most efficient way to deal with the problem, but I like having this intermediate <code>.csv</code> file on hand as I subject these data to several other processing steps besides marine heat wave detection.</p>
<p>Here is a set of steps that does the job for me:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generic_netCDF2csv.R</span>


<span class="co"># NOTES ON USING THIS SCRIPT ----------------------------------------------</span>

<span class="co"># 1. The Reynolds OISST v2 data processed by this script can be retrieved from:</span>
<span class="co"># https://podaac.jpl.nasa.gov/dataset/AVHRR_OI-NCEI-L4-GLOB-v2.0</span>
<span class="co"># 2. Subsetting and the selection of the time steps to be done via the python</span>
<span class="co"># script `subset_dataset.py`.</span>
<span class="co"># 3. This R script requires the already subsetted netCDFs to reside inside a</span>
<span class="co"># directory whose path is specified by `nc.dir`, below.</span>
<span class="co"># 4. The .csv files produced will be placed inside of the directory named by</span>
<span class="co"># `csv.dir` (make sure this directory already exists).</span>
<span class="co"># 5. The dates that will be included with the final .csv file will be extracted</span>
<span class="co"># directly from the names of the daily netCDF files; please, therefore, make</span>
<span class="co"># sure to never change them by manually editing them.</span>
<span class="co"># 6. The base name of the new .csv file will be partly based on the name of the</span>
<span class="co"># input netCDF files, with the start and end dates appended at the end. These</span>
<span class="co"># things are hard coded into the script below.</span>
<span class="co"># 7. I am sure I have missed some things, or that some things may break somehow;</span>
<span class="co"># please let me know if this happens and I shall fix it.</span>
<span class="co"># 8. This file may take a while to run (10s of minutes to hours, depending on</span>
<span class="co"># the amount of data processed); please be patient while it does its thing.</span>

<span class="co"># Author: AJ Smit</span>
<span class="co"># Date: 27 April 2018</span>
<span class="co"># e-mail: ajsmit@uwc.ac.za</span>


<span class="co"># </span><span class="al">CAUTION</span><span class="co"> -----------------------------------------------------------------</span>

<span class="co"># This function will append data to the end of an existing file that had been</span>
<span class="co"># previously produced by this script. This will result in duplicate data. If you</span>
<span class="co"># need to rerun the script for some reason, please make sure to delete the file</span>
<span class="co"># created as the result of the previous run from the `csv.dir`.</span>


<span class="co"># LOAD LIBRARIES ----------------------------------------------------------</span>

<span class="kw">library</span>(ncdf4) <span class="co"># library for processing netCDFs</span>
<span class="kw">library</span>(data.table) <span class="co"># for fast .csv write function, `fwrite()`</span>
<span class="kw">library</span>(tidyverse) <span class="co"># misc. data processing conveniences</span>
<span class="kw">library</span>(reshape2) <span class="co"># for making a long data format</span>
<span class="kw">library</span>(plyr) <span class="co"># for `llply()`</span>
<span class="kw">library</span>(lubridate) <span class="co"># for working with dates</span>
<span class="kw">library</span>(stringr) <span class="co"># for working with strings</span>
<span class="kw">library</span>(doMC); doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="dv">4</span>) <span class="co"># for multicore spead-ups</span>


<span class="co"># SPECIFY FILE PATHS ------------------------------------------------------</span>

<span class="co"># Setup OISST netCDF data path and csv file output directory</span>
nc.dir &lt;-<span class="st"> &quot;/Users/ajsmit/spatial/test/netCDF&quot;</span>
csv.dir &lt;-<span class="st"> &quot;/Users/ajsmit/spatial/test/csv&quot;</span>


<span class="co"># PARSE FILE INFO (not used directly) -------------------------------------</span>

<span class="co"># Use to determine the start/end points of the `name.stem` (see code below)</span>
<span class="co">#          1         2         3         4         5         6         7</span>
<span class="co"># 123456789012345678901234567890123456789012345678901234567890123456789012345</span>
<span class="co"># 20091231120000-NCEI-L4_GHRSST-SSTblend-AVHRR_OI-GLOB-v02.0-fv02.0_subset.nc</span>


<span class="co"># OISST netCDF READ FUNCTION ----------------------------------------------</span>

<span class="co"># Function to extract the dims and data from OISST netCDFs</span>
ncRead &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">nc.dir =</span> nc.dir, <span class="dt">csv.dir =</span> csv.dir) {
  nc.list &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> nc.dir, <span class="dt">pattern =</span> <span class="st">&quot;*.nc&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>, <span class="dt">include.dirs =</span> <span class="ot">TRUE</span>)
  strt.date &lt;-<span class="st"> </span><span class="kw">str_sub</span>(<span class="kw">basename</span>(nc.list[<span class="dv">1</span>]), <span class="dt">start =</span> <span class="dv">1</span>, <span class="dt">end =</span> <span class="dv">8</span>)
  end.date &lt;-<span class="st"> </span><span class="kw">str_sub</span>(<span class="kw">basename</span>(nc.list[<span class="kw">length</span>(nc.list)]), <span class="dt">start =</span> <span class="dv">1</span>, <span class="dt">end =</span> <span class="dv">8</span>)

  ncFun &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">nc.file =</span> nc.file, <span class="dt">csv.dir =</span> csv.dir) {
    nc &lt;-<span class="st"> </span><span class="kw">nc_open</span>(nc.file)
    name.stem &lt;-<span class="st"> </span><span class="kw">substr</span>(<span class="kw">basename</span>(nc.file), <span class="dv">16</span>, <span class="dv">72</span>)
    date.stamp &lt;-<span class="st"> </span><span class="kw">substr</span>(<span class="kw">basename</span>(nc.file), <span class="dv">1</span>, <span class="dv">8</span>)
    sst &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">ncvar_get</span>(nc, <span class="dt">varid =</span> <span class="st">&quot;analysed_sst&quot;</span>), <span class="dv">4</span>)
    <span class="kw">dimnames</span>(sst) &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">lon =</span> nc<span class="op">$</span>dim<span class="op">$</span>lon<span class="op">$</span>vals,
                          <span class="dt">lat =</span> nc<span class="op">$</span>dim<span class="op">$</span>lat<span class="op">$</span>vals)
    <span class="kw">nc_close</span>(nc)
    sst &lt;-
<span class="st">      </span><span class="kw">as.data.frame</span>(<span class="kw">melt</span>(sst, <span class="dt">value.name =</span> <span class="st">&quot;temp&quot;</span>), <span class="dt">row.names =</span> <span class="ot">NULL</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">t =</span> <span class="kw">ymd</span>(date.stamp)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">na.omit</span>()
    <span class="co"># Use data.table's `fwrite()` because it is much faster than anything else</span>
    <span class="co"># for large csv files</span>
    <span class="kw">fwrite</span>(sst,
           <span class="dt">file =</span> <span class="kw">paste0</span>(csv.dir, <span class="st">&quot;/&quot;</span>, name.stem, <span class="st">&quot;-&quot;</span>, strt.date, <span class="st">&quot;-&quot;</span>, end.date, <span class="st">&quot;.csv&quot;</span>),
           <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">col.names =</span> <span class="ot">FALSE</span>)
    <span class="kw">rm</span>(sst)
  }
  <span class="co"># `parallel = FALSE` allows for better error checking should something go wrong;</span>
  <span class="co"># there's also a helpful progress bar that becomes available</span>
  <span class="kw">llply</span>(nc.list, ncFun, <span class="dt">csv.dir =</span> csv.dir, <span class="dt">.parallel =</span> <span class="ot">FALSE</span>)
}</code></pre></div>
<p>Now I simply run this function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># RUN THE FUNCTION --------------------------------------------------------</span>

<span class="co"># If everything works according to plan, all that's required is to execute</span>
<span class="co"># this line as is after specifying `nc.dir` and `csv.dir` paths, above</span>
<span class="kw">system.time</span>(<span class="kw">ncRead</span>(nc.dir, csv.dir))</code></pre></div>
</div>
<div id="event-detection" class="section level2">
<h2>Event detection</h2>
<p>Now we shall detect the extreme heat events using the <strong>RmarineHeaWaves</strong> package (soon to be replaced with <strong>heatwaveR</strong>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># SET-UP SOME THINGS ------------------------------------------------------</span>

csv.dir &lt;-<span class="st"> &quot;/Users/ajsmit/spatial/test/csv&quot;</span>

<span class="co"># Specify the name of the file created by `system.time(ncRead(nc.dir, csv.dir))` in the</span>
<span class="co"># `csv.dir` that was named above</span>
csv.file &lt;-<span class="st"> &quot;NCEI-L4_GHRSST-SSTblend-AVHRR_OI-GLOB-v02.0-fv02.0_subset-19810901-20171014.csv&quot;</span>

<span class="co"># Read in the data in the combined .csv file and assign column names;</span>
<span class="co"># again using the data.table way (`fread()`), which is FAST...</span>
sst.dat &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="kw">paste0</span>(csv.dir, <span class="st">&quot;/&quot;</span>, csv.file))
<span class="kw">colnames</span>(sst.dat) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;temp&quot;</span>, <span class="st">&quot;t&quot;</span>)


<span class="co"># A FAST DATE FUNCTION ----------------------------------------------------</span>

<span class="co"># This speeds the creation of the date vector up immensely</span>
fastDate &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">tz =</span> <span class="ot">NULL</span>) {
  <span class="kw">require</span>(fasttime)
  <span class="kw">as.Date</span>(<span class="kw">fastPOSIXct</span>(x, <span class="dt">tz =</span> tz))
}


<span class="co"># APPLY FAST DATE FUNCTION ------------------------------------------------</span>

sst.dat<span class="op">$</span>t &lt;-<span class="st"> </span><span class="kw">fastDate</span>(sst.dat<span class="op">$</span>t)


<span class="co"># DETECT FUNCTION FOR GRIDDED DATA ----------------------------------------</span>

<span class="co"># The `clim` switch selects either climatology or events as output;</span>
<span class="co"># please provide your own date range in here</span>
OISST_detect &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">dat =</span> data, <span class="dt">doy =</span> doy, <span class="dt">x =</span> t, <span class="dt">y =</span> temp,
                         <span class="dt">warm =</span> <span class="ot">TRUE</span>, <span class="dt">clim =</span> <span class="ot">FALSE</span>,
                         <span class="dt">climatology_start =</span> <span class="st">&quot;1983-01-01&quot;</span>,
                         <span class="dt">climatology_end =</span> <span class="st">&quot;2012-12-31&quot;</span>) {
  <span class="kw">require</span>(RmarineHeatWaves)
  dat &lt;-<span class="st"> </span>dat[,<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>] <span class="co"># hard-code cols with temp and date</span>
  whole &lt;-<span class="st"> </span><span class="kw">make_whole</span>(dat)
  <span class="cf">if</span> (warm) {
    out &lt;-<span class="st"> </span><span class="kw">detect</span>(whole, <span class="dt">min_duration =</span> <span class="dv">5</span>, <span class="dt">max_gap =</span> <span class="dv">2</span>, <span class="dt">cold_spells =</span> <span class="ot">FALSE</span>,
                  <span class="dt">climatology_start =</span> climatology_start,
                  <span class="dt">climatology_end =</span> climatology_end)
  } <span class="cf">else</span> {
    out &lt;-<span class="st"> </span><span class="kw">detect</span>(whole, <span class="dt">min_duration =</span> <span class="dv">5</span>, <span class="dt">max_gap =</span> <span class="dv">2</span>, <span class="dt">cold_spells =</span> <span class="ot">TRUE</span>,
                  <span class="dt">climatology_start =</span> climatology_start,
                  <span class="dt">climatology_end =</span> climatology_end)
  }
  <span class="cf">if</span> (clim) {
    clim &lt;-<span class="st"> </span>out<span class="op">$</span>clim
    <span class="kw">return</span>(clim)
  } <span class="cf">else</span> {
    event &lt;-<span class="st"> </span>out<span class="op">$</span>event
    <span class="kw">return</span>(event)
  }
}


<span class="co"># DETECT EVENTS! ----------------------------------------------------------</span>

events &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">ddply</span>(sst.dat, .(lon, lat), OISST_detect,
                          <span class="dt">warm =</span> <span class="ot">TRUE</span>, <span class="dt">clim =</span> <span class="ot">FALSE</span>,
                          <span class="dt">.parallel =</span> <span class="ot">FALSE</span>, <span class="dt">.progress =</span> <span class="st">&quot;text&quot;</span>))


<span class="co"># SAVE AND CLEAN UP -------------------------------------------------------</span>
event.dir &lt;-<span class="st"> &quot;/Users/ajsmit/spatial/test/events&quot;</span>

<span class="co"># Reuse the existing name; this ensures traceability of the files back to</span>
<span class="co"># the input sources</span>
event.file &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.csv$&quot;</span>, <span class="st">&quot;&quot;</span>, csv.file)

<span class="co"># Write the file out to disk</span>
<span class="kw">fwrite</span>(events, <span class="dt">file =</span> <span class="kw">paste0</span>(<span class="st">&quot;event.dir&quot;</span>, <span class="st">&quot;/&quot;</span>, event.file, <span class="st">&quot;-events.csv&quot;</span>))
<span class="kw">remove</span>(events); <span class="kw">remove</span>(sst.dat)</code></pre></div>
<p>Please let me know if there are issues with the scripts, or if you have suggesations about how to improve them.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
