<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Robert W Schlegel and AJ Smit" />

<meta name="date" content="2019-09-09" />

<title>Downloading and Preparing NOAA OISST Data</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Downloading and Preparing NOAA OISST Data</h1>
<h4 class="author">Robert W Schlegel and AJ Smit</h4>
<h4 class="date">2019-09-09</h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>In this vignette we will see how to retrieve and prepare <a href="https://journals.ametsoc.org/doi/full/10.1175/2007JCLI1824.1">Reynolds optimally interpolated sea surface temperature</a> (OISST) data for calculating marine heatwaves (MHWs). The OISST product is a global 1/4 degree gridded dataset of Advanced Very High Resolution Radiometer (AVHRR) derived SSTs at a daily resolution, starting on 1 September 1981. The source of the data is currently the <a href="https://www.ncdc.noaa.gov/oisst">NOAA NCDC</a>.</p>
<p>Each daily global file is around 8.3 MB, so they add up to a large amount of data when a time series of the recommended 30 year minimum duration for the detection of MHWs is downloaded. If one were to download all of the data currently available it would exceed 100 GB of total disk space. It is therefore best practice to download only a subset of the data as would match one’s study area. Thanks to the <a href="https://docs.ropensci.org/rerddap/"><strong><code>rerddap</code></strong> package</a> this is easy to do in <code>R</code>.</p>
</div>
<div id="downloading-and-preparing-data" class="section level2">
<h2>Downloading and preparing data</h2>
<p>For this vignette we will be accessing the NOAA OISST data hosted on this <a href="https://www.ncei.noaa.gov/erddap/griddap/ncdc_oisst_v2_avhrr_by_time_zlev_lat_lon.html">ERDDAP web interface</a>. One may download the data there manually with the user friendly web interface, or use the <strong><code>rerddap</code></strong> package to do the same through <code>R</code>. Due to some recent developments the <strong><code>rerddap</code></strong> package on CRAN may provide an unstable interface to the NOAA ERDDAP servers. This issue has already been addressed in the development version of the package and so we will begin by installing the package from <code>GitHub</code>. Please note that this package has quite a few dependencies and so may take a few minutes to install. If any errors are encountered during this process please consult the GitHub page <a href="https://github.com/ropensci/rerddap">here</a>. We will also need functionality in the <strong><code>tidyverse</code></strong> package that is only available in the development version so we will be installing that from <code>GitHub</code> as well.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># The two packages we will need</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="co"># NB: The packages only need to be installed from GitHub once</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># devtools::install_github(&quot;tidyverse/tidyverse&quot;)</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># devtools::install_github(&quot;ropensci/rerddap&quot;)</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co"># Load the packages once they have been downloaded and installed</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">library</span>(rerddap)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># The information for the NOAA OISST data</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">rerddap<span class="op">::</span><span class="kw">info</span>(<span class="dt">datasetid =</span> <span class="st">&quot;ncdc_oisst_v2_avhrr_by_time_zlev_lat_lon&quot;</span>, <span class="dt">url =</span> <span class="st">&quot;https://www.ncei.noaa.gov/erddap/&quot;</span>)</a></code></pre></div>
<p>With our packages loaded and our target dataset identified we may now begin the download with the <code>griddap()</code> function. While putting this vignette together however I noticed one little hiccup in the work flow. It seems that the ERDDAP server does not like it when one tries to access more than nine consecutive years of data in one request, regardless of the spatial extent being requested. So before we download our data we are going to make a wrapper function that helps us control the range of times we want to download. This will reduce the amount of redundant coding we would otherwise need to do.</p>
<div id="the-download-function" class="section level3">
<h3>The download function</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># This function expects the user to provide it with a start and end date</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># It then downloads and prepares the data</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">OISST_sub &lt;-<span class="st"> </span><span class="cf">function</span>(time_df){</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  oisst_res &lt;-<span class="st"> </span><span class="kw">griddap</span>(<span class="dt">x =</span> <span class="st">&quot;ncdc_oisst_v2_avhrr_by_time_zlev_lat_lon&quot;</span>, </a>
<a class="sourceLine" id="cb2-5" data-line-number="5">                       <span class="dt">url =</span> <span class="st">&quot;https://www.ncei.noaa.gov/erddap/&quot;</span>, </a>
<a class="sourceLine" id="cb2-6" data-line-number="6">                       <span class="dt">time =</span> <span class="kw">c</span>(time_df<span class="op">$</span>start, time_df<span class="op">$</span>end), </a>
<a class="sourceLine" id="cb2-7" data-line-number="7">                       <span class="dt">depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">                       <span class="dt">latitude =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">40</span>, <span class="dv">-35</span>),</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">                       <span class="dt">longitude =</span> <span class="kw">c</span>(<span class="dv">15</span>, <span class="dv">21</span>),</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">                       <span class="dt">fields =</span> <span class="st">&quot;sst&quot;</span>)<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">time =</span> <span class="kw">as.Date</span>(<span class="kw">str_remove</span>(time, <span class="st">&quot;T00:00:00Z&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">t =</span> time, <span class="dt">temp =</span> sst) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="st">    </span><span class="kw">select</span>(lon, lat, t, temp) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="st">    </span><span class="kw">na.omit</span>()</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">}</a></code></pre></div>
<p>In the wrapper function above we see that we have chosen to download only the ‘sst’ data out of the several variables (‘fields’) available to us. We also see that we have chosen the spatial extent of latitude -40 to -35 and longitude 15 to 21. This a small window over some of the Agulhas Retroflection to the south west of the coastline of South Africa. A larger area is not being chosen here simply due to the speed constraints of downloading the data and detecting the events therein. One may simply change the lon/lat values above as necessary to match the desired study area. The function will also be re-labelling the ‘time’ column as ‘t’, and the ‘sst’ column as ‘temp’. We do this so that they match the default column names that are expected for calculating MHWs and we won’t have to do any extra work later on.</p>
<p>One must note here that depending on the RAM available on one’s machine, it may not be possible to handle all of the data downloaded at once if they are very large (e.g. &gt; 5 GB). The discussion on the limitations of the R language due to its dependence on virtual memory is beyond the scope of this vignette, but if one limits one’s downloads to no more than several square pixels at a time that should be fine. Were one to try to download the whole Indian Ocean, for example, that may cause issues if being run on a laptop or computer of a similar power.</p>
</div>
<div id="the-date-range" class="section level3">
<h3>The date range</h3>
<p>With our wrapper function written we would now need to run it several times in order to grab all of the OISST data from <code>1982-01-01</code> to <code>2018-12-31</code>. Even though each year of data for the extent used in this vignette is only ~360 KB, the server does not like it when more than 9 years of consecutive data are requested. The server will also end a users connection after ~17 individual files have been requested. Because we can’t download all of the data in one request, and we can’t download the data one year at a time, we will need to make requests for multiple batches of data. To accomplish this we will create a dataframe of start and end dates that will allow us to automate the entire download while meeting the aforementioned criteria.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Date download range by start and end dates per year</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">dl_years &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">date_index =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                       <span class="dt">start =</span> <span class="kw">as.Date</span>(<span class="kw">c</span>(<span class="st">&quot;1982-01-01&quot;</span>, <span class="st">&quot;1990-01-01&quot;</span>, </a>
<a class="sourceLine" id="cb3-4" data-line-number="4">                                         <span class="st">&quot;1998-01-01&quot;</span>, <span class="st">&quot;2006-01-01&quot;</span>, <span class="st">&quot;2014-01-01&quot;</span>)),</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                       <span class="dt">end =</span> <span class="kw">as.Date</span>(<span class="kw">c</span>(<span class="st">&quot;1989-12-31&quot;</span>, <span class="st">&quot;1997-12-31&quot;</span>, </a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                                       <span class="st">&quot;2005-12-31&quot;</span>, <span class="st">&quot;2013-12-31&quot;</span>, <span class="st">&quot;2018-12-31&quot;</span>)))</a></code></pre></div>
</div>
<div id="the-data" class="section level3">
<h3>The data</h3>
<p>One could also use the <strong><code>plyr</code></strong> suite of functions to automate the process of downloading and processing multiple files, but I’ve chosen here to stick with the <strong><code>tidyverse</code></strong> native approach. If the below chunk of code fails or times out, simply re-run it until all of the data have been downloaded.</p>
<p>It is worth pointing out here that these data are downloaded as cached files on the users computer by using the <strong><code>hoardr</code></strong> package. This means that if one runs the same command again, it will not re-download the data because it first looks in the folder where it has automatically cached the data for you and sees that it may simply draw the data from there. No need to change anything or write a second script for loading data.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Download all of the data with one nested request</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># The time this takes will vary greatly based on connection speed</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">system.time</span>(</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  OISST_data &lt;-<span class="st"> </span>dl_years <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="st">    </span><span class="kw">group_by</span>(date_index) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="st">    </span><span class="kw">group_modify</span>(<span class="op">~</span><span class="kw">OISST_sub</span>(.x)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="st">    </span><span class="kw">select</span>(lon, lat, t, temp)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">) <span class="co"># 921 seconds, ~184 seconds per batch</span></a></code></pre></div>
<p>If the above code chunk is giving errors it is likely due to either not having the development version of the <strong><code>tidyverse</code></strong> installed (see beginning of vignette), or one’s Internet connection is timing out. There are also rare instances where the NOAA server is not responding due to an issue on their end. Any connection based issues may be resolved by simply waiting for a few minutes, or by ensuring a stable connection.</p>
</div>
<div id="the-saved-file" class="section level3">
<h3>The saved file</h3>
<p>With the data downloaded and prepared for further use, all that’s left to do is save them.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Save the data as an .Rda file as it has a much better compression rate than .RData</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">saveRDS</span>(OISST_data, <span class="dt">file =</span> <span class="st">&quot;~/Desktop/OISST_vignette.Rda&quot;</span>)</a></code></pre></div>
<p>Note above that I have chosen to save the file to my desktop. This is not normally where one (hopefully!) would save such a file. Rather one would be saving these data into the project folder out of which one is working. In the next vignette we will see how to <a href="https://robwschlegel.github.io/heatwaveR/articles/gridded_event_detection.html">detect MHWs in gridded data</a>.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
